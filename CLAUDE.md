# M-Y-AI — Claude Code Guide

This file provides everything Claude needs to understand and work on the **m-y-ai** codebase.

---

## Project Overview

**m-y-ai** is a secure 24x7 personal AI assistant gateway. It routes messages from multiple platforms (web browser, mobile app, desktop) to Claude Agent SDK and streams responses back. The agent runs inside a Docker container that includes a full Ubuntu desktop accessible via VNC/noVNC.

**Stack**: Node.js (ESM, `"type": "module"`), Claude Agent SDK, WebSockets, Docker/Ubuntu 22.04

---

## Repository Layout

```
m-y-ai/
├── gateway.js            # Main entry — Gateway class, adapter wiring, HTTP server
├── config.js             # Platform + agent config (reads from env vars)
├── cli.js                # CLI entry point (start / chat / setup subcommands)
├── package.json          # Entry: gateway.js | bin: cli.js

├── agent/
│   ├── claude-agent.js   # ClaudeAgent class — system prompt, MCP tools, streaming
│   └── runner.js         # AgentRunner — per-session message queue, executeRun

├── providers/
│   ├── index.js          # getProvider() factory + cache
│   ├── base-provider.js  # BaseProvider abstract (session map, model get/set)
│   ├── claude-provider.js# Uses @anthropic-ai/claude-agent-sdk query()
│   └── opencode-provider.js # Uses @opencode-ai/sdk (local OpenCode server)

├── messaging/
│   ├── messaging.js      # PlatformAdapter base class + MessagingManager
│   └── adapters/
│       ├── web.js        # WebSocket adapter (browser web app)
│       ├── app.js        # WebSocket adapter (mobile app)
│       └── desktop.js    # WebSocket adapter (desktop app / Tauri)

├── sessions/
│   └── session-manager.js # Transcript storage per session key

├── memory/
│   └── memory-manager.js  # MEMORY.md (long-term) + ~/Memory/YYYY-MM-DD.md (daily)

├── commands/
│   └── command-handler.js # Slash command router (/new /status /memory /model …)

├── tools/
│   ├── cron.js           # In-process MCP server for cron scheduling
│   └── gateway.js        # In-process MCP server exposing gateway actions to agent

├── scripts/
│   ├── entrypoint.sh     # Docker startup: Xvfb → mutter → tint2 → x11vnc → noVNC → node gateway.js
│   ├── setup.sh          # First-run setup helper
│   ├── xvfb_startup.sh   # Virtual display
│   ├── mutter_startup.sh # Window manager
│   ├── tint2_startup.sh  # Taskbar
│   ├── x11vnc_startup.sh # VNC server (port 5901)
│   └── novnc_startup.sh  # noVNC web proxy (port 6080)

├── storage/              # Seeded into ~/  inside Docker at build time
├── Dockerfile            # Ubuntu 22.04 + desktop + Node 20 + Claude Code + Opencode
├── docker-compose.yml    # Ports: 4227 (gateway), 5901 (VNC), 6080 (noVNC)
└── .env.example          # ANTHROPIC_API_KEY, DEFAULT_MODEL, PROVIDER

├── ui/                   # ← DO NOT MODIFY (separate UIs)
│   ├── web/              #   Next.js web app
│   ├── app/              #   React Native mobile app
│   └── desktop/          #   Tauri desktop app
```

---

## Core Concepts

### Session Keys

Format: `agent:<agentId>:<platform>:<type>:<id>`  
Example: `agent:m-y-ai:web:dm:abc-uuid`

Session keys are generated by each adapter's `generateSessionKey()` and used as conversation identifiers throughout the runner, provider, and memory systems.

### Message Flow

```
User (WebSocket/App/Desktop)
  → PlatformAdapter.dispatch()
    → Gateway.setupAdapter() onMessage handler
      → CommandHandler.execute()   (slash commands short-circuit here)
      → AgentRunner.enqueueRun()   (per-session FIFO queue)
        → AgentRunner.executeRun()
          → ClaudeAgent.run()      (async generator)
            → Provider.query()     (Claude SDK or Opencode)
            → [yields text/tool chunks]
          → adapter.sendMessage()  (streams back to user)
```

### Providers

| Provider | Class | SDK | Notes |
|---|---|---|---|
| `claude` | `ClaudeProvider` | `@anthropic-ai/claude-agent-sdk` | Default. Resumes sessions via `session_id`. |
| `opencode` | `OpencodeProvider` | `@opencode-ai/sdk` | Connects to local Opencode server at `127.0.0.1:2727`. |

Switch at runtime with `/provider` command. Config in `config.js` → `agent.provider`.

### MCP Tools (Built-in)

The agent always has three built-in in-process MCP servers:

| Server | Key | Tools |
|---|---|---|
| Cron scheduler | `cron` | `schedule_delayed`, `schedule_recurring`, `schedule_cron`, `list_scheduled`, `cancel_scheduled` |
| Gateway | `gateway` | `send_message`, `list_platforms`, `get_queue_status`, `get_current_context`, `list_sessions`, `broadcast_message` |
| AppleScript (macOS only) | `applescript` | `run_script`, `list_apps`, `activate_app`, `display_notification` |

External MCP servers (e.g. Composio) are injected via `gateway.mcpServers` and merged in `ClaudeAgent.run()`.

### Memory System

- **Long-term**: `~/MEMORY.md` — curated facts, preferences, decisions
- **Daily logs**: `~/Memory/YYYY-MM-DD.md` — append-only timestamped notes
- Loaded into every system prompt via `MemoryManager.getMemoryContext()`
- Agent only writes memory when user explicitly asks

### Slash Commands

| Command | Action |
|---|---|
| `/new` or `/reset` | Clear session + transcript |
| `/status` | Show session stats + queue depth |
| `/memory` | Show long-term + today's memory |
| `/memory list` | List all saved memory files |
| `/memory search <q>` | Search memory files |
| `/queue` | Show global queue stats |
| `/model [n]` | List or switch AI model |
| `/provider [name]` | List or switch provider |
| `/stop` | Abort current agent run |
| `/help` | Show all commands |

---

## Environment Variables

```env
# Required
ANTHROPIC_API_KEY=sk-ant-...

# Optional
DEFAULT_MODEL=""                   # e.g. claude-opus-4-6
PROVIDER=Anthropic                 # or Opencode

# Platform allow-lists (comma-separated IDs, or * for all)
WHATSAPP_ALLOWED_DMS=*
WHATSAPP_ALLOWED_GROUPS=
TELEGRAM_BOT_TOKEN=
TELEGRAM_ALLOWED_DMS=*
TELEGRAM_ALLOWED_GROUPS=
IMESSAGE_ALLOWED_DMS=
IMESSAGE_ALLOWED_GROUPS=
```

Copy `.env.example` → `.env` and fill in values.

---

## Running Locally

```bash
# Install dependencies
npm install

# Start the gateway
npm start
# or
node gateway.js

# Interactive CLI
npm run cli
node cli.js chat
```

---

## Docker

```bash
# Build + run
docker compose up --build

# Ports exposed:
#   4227 — Node.js gateway API + health check
#   5901 — VNC (native client: vnc://localhost:5901)
#   6080 — noVNC browser UI (http://localhost:6080/vnc.html)
```

The Docker image includes:

- Ubuntu 22.04 full desktop (Xvfb + Mutter WM + tint2 taskbar)
- Firefox ESR, LibreOffice, gedit, pcmanfm
- Node.js 20, Claude Code CLI (`@anthropic-ai/claude-code`), Opencode CLI
- noVNC for browser-based desktop access

The `storage/` directory is seeded into `/home/m-y-ai/` at build time and persisted via the `memory` Docker volume across restarts.

---

## Adding a New Platform Adapter

1. Create `messaging/adapters/<platform>.js` extending `PlatformAdapter` from `messaging/messaging.js`
2. Implement `start()`, `stop()`, `send(chatId, text)`, and call `this.dispatch(message)` on inbound messages
3. Optionally implement `sendTyping(chatId)`, `stopTyping(chatId)`, `react(chatId, msgId, emoji)`
4. Import and register in `gateway.js` alongside the existing web/app/desktop adapters
5. Add platform config block to `config.js`

### PlatformAdapter Contract

```js
// Normalized inbound message shape:
{
  platform: 'web' | 'app' | 'desktop' | ...,
  chatId: string,       // unique conversation ID
  text: string,
  sender: string,
  isGroup: boolean,
  mentions: string[],
  image: { data: string, mediaType: string } | null,
  raw: any              // original platform frame
}
```

---

## Key Architecture Notes

- **ESM only** — all files use `import`/`export`. Do not use `require()`.
- **Per-session FIFO queues** — `AgentRunner` serialises concurrent messages per session; different sessions run in parallel.
- **Streaming** — `ClaudeAgent.run()` is an async generator. Text chunks are sent to the user as they arrive; buffering happens only around tool calls.
- **Tool approval** — `canUseTool` callback in `AgentRunner.createMessagingCanUseTool()` asks the user via the messaging adapter before executing sensitive tools. Responses time out after 120 s.
- **Agent workspace** — `~/m-y-ai/` is the agent's home for files. In Docker this maps to `/home/m-y-ai/`.
- **System prompt identity** — Agent presents as "Secure OpenClaw" in the system prompt (legacy name); the project/package name is `m-y-ai`.
- **Port 4227** — HTTP server for health check (`GET /`) and WhatsApp QR display (`GET /qr`).

---

## Dependencies

| Package | Purpose |
|---|---|
| `@anthropic-ai/claude-agent-sdk` | Claude agent execution + tool use |
| `@opencode-ai/sdk` | Opencode provider (alternative LLM backend) |
| `ws` | WebSocket server for all platform adapters |
| `dotenv` | Environment variable loading |
| `pino` | Structured logging |
| `qrcode` + `qrcode-terminal` | WhatsApp QR code rendering |
| `zod` | Schema validation |
| `oh-my-logo` | ASCII logo in CLI |


### Create a shadcn project

Quick Start
Run the following command to create a new project with shadcn/ui:

npm
npx shadcn@latest create

bun
bunx --bun shadcn@latest create

  Run the `init` command to create a new Next.js project or to setup an existing one:

  npx shadcn@latest add button

  bunx --bun shadcn@latest add button

  Choose between a Next.js project or a Monorepo.

  ### Add Components

  You can now start adding components to your project.

  npx shadcn@latest add button


  ```
  bunx --bun shadcn@latest add button
  ```

  The command above will add the `Button` component to your project. You can then import it like this:

  app/page.tsx

import { Button } from "@/components/ui/button"

export default function Home() {
  return (
    `<div>`
      `<Button>`Click me `</Button>`
    `</div>`
  )
}
