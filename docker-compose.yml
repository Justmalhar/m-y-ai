services:
  m-y-ai:
    build:
      context: .
      dockerfile: Dockerfile
    env_file: .env
    ports:
      - "4227:4227" # Node.js gateway / REST API
      - "5901:5901" # VNC  (native VNC client, e.g. Screen Sharing / RealVNC)
      - "6080:6080" # noVNC browser UI → http://localhost:6080/vnc.html
    volumes:
      # Named volume persists runtime changes to ~/storage across container restarts.
      # The Dockerfile seeds it with the repo's storage/ contents at build time.
      - memory:/home/m-y-ai/
    restart: unless-stopped
    # Override display/resolution at compose time if needed:
    # environment:
    #   - WIDTH=1920
    #   - HEIGHT=1080

  web-ui:
    build:
      context: ./ui/web
      dockerfile: Dockerfile
      args:
        # NEXT_PUBLIC_* are baked into the client bundle at build time.
        # The browser connects to the gateway directly — use the host-visible URL.
        NEXT_PUBLIC_GATEWAY_WS_URL: ${NEXT_PUBLIC_GATEWAY_WS_URL:-ws://localhost:4227/ws}
        NEXT_PUBLIC_APP_NAME: ${NEXT_PUBLIC_APP_NAME:-m-y.ai}
    env_file: .env          # supplies GATEWAY_PASSWORD at runtime
    environment:
      - NODE_ENV=production
      - PORT=3000
    ports:
      - "3000:3000"         # web UI → http://localhost:3000
    depends_on:
      - m-y-ai
    restart: unless-stopped

volumes:
  memory:
